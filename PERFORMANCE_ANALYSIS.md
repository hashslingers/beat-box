# BeatBox Pro - Performance & Usability Analysis

**Analyst:** Codabot (Show Runner)
**Date:** 2026-01-30
**Version Analyzed:** Current main branch

## Executive Summary

The app has solid audio architecture but suffers from **visualization performance issues** and **DOM inefficiencies** that cause sluggishness. The core beat scheduling is well-designed (mobile-optimized lookahead), but the visual feedback system needs optimization.

---

## Critical Issues Found

### 1. Excessive DOM Queries Per Beat (HIGH IMPACT)

**Problem:** Every beat triggers multiple `querySelectorAll` and `querySelector` calls:

```javascript
// Called 8x per measure at 120 BPM = ~16 times/second
function updateBeatCircle(step) {
  const segments = document.querySelectorAll('.beat-segment'); // DOM query
  segments.forEach((seg, i) => {
    seg.classList.toggle('active', i === step);
  });
  // ...
}

function updateStepUI(step) {
  document.querySelectorAll('.step.playing').forEach(el => {  // DOM query
    el.classList.remove('playing');
  });
  // ...
}
```

**Impact:** DOM queries are expensive. At 120 BPM with 8 steps, this runs 16+ times/second, each time querying the entire DOM tree.

**Fix:** Cache DOM references on initialization:
```javascript
// At init time
const beatSegments = document.querySelectorAll('.beat-segment');
const stepElements = {
  kick: document.querySelectorAll('#kick-steps .step'),
  snare: document.querySelectorAll('#snare-steps .step'),
  hihat: document.querySelectorAll('#hihat-steps .step')
};

// Per beat - O(1) instead of O(n) DOM traversal
function updateBeatCircle(step) {
  beatSegments.forEach((seg, i) => {
    seg.classList.toggle('active', i === step);
  });
}
```

---

### 2. Multiple setTimeout Per Beat (MEDIUM IMPACT)

**Problem:** Every beat triggers 3-6 setTimeout calls for animation cleanup:

```javascript
function triggerVisualPulse(step) {
  document.body.classList.add('beat-one-pulse');
  setTimeout(() => document.body.classList.remove('beat-one-pulse'), 180);  // Timer 1
  
  if (patterns.kick[step]) {
    sequencer.classList.add('kick-hit');
    setTimeout(() => sequencer.classList.remove('kick-hit'), 150);  // Timer 2
  }
  // ... more timers for snare, hihat
}
```

**Impact:** Timer overhead adds up. 5 setTimeout calls Ã— 16 beats/second = 80 timers/second.

**Fix:** Use CSS animations with `animation-fill-mode: forwards` or single requestAnimationFrame cleanup:
```css
.kick-hit {
  animation: kick-flash 150ms ease-out forwards;
}
@keyframes kick-flash {
  0% { background: rgba(255, 0, 0, 0.2); }
  100% { background: transparent; }
}
```

---

### 3. Draw Loop Runs Continuously (LOW-MEDIUM IMPACT)

**Problem:** The `draw()` function runs via `requestAnimationFrame` even when stopped:

```javascript
function draw() {
  if (!audioCtx) return requestAnimationFrame(draw);  // Still loops!
  // ...
  requestAnimationFrame(draw);
}
```

**Impact:** Constant 60fps CPU usage even when idle.

**Fix:** Only run draw loop when playing:
```javascript
let drawLoopRunning = false;

function startDrawLoop() {
  if (drawLoopRunning) return;
  drawLoopRunning = true;
  requestAnimationFrame(draw);
}

function draw() {
  if (!isPlaying) {
    drawLoopRunning = false;
    return;  // Stop looping
  }
  // ... rest of draw logic
  requestAnimationFrame(draw);
}
```

---

### 4. Beat Circle SVG Not Rendering (VISUALIZATION BUG)

**Problem:** The comment says "Segments and playhead will be generated by JavaScript" but I need to verify the generation code is actually running and creating valid SVG elements.

**Location to check:** Search for where `beatCircle` SVG children are created.

---

### 5. Drone Wheel Scroll Janky (UX ISSUE)

Based on the code, the drone wheel uses CSS scroll snapping. May need:
- `scroll-behavior: smooth`
- Touch action optimization
- Debounced scroll handlers

---

## Performance Optimization Checklist

| Priority | Issue | Estimated Gain | Effort |
|----------|-------|----------------|--------|
| ðŸ”´ P0 | Cache DOM references | 30-50% CPU reduction | Low |
| ðŸ”´ P0 | Fix draw loop idle behavior | 20% idle CPU | Low |
| ðŸŸ  P1 | Replace setTimeout with CSS animations | 10-20% | Medium |
| ðŸŸ  P1 | Debug beat circle SVG generation | Fix broken viz | Medium |
| ðŸŸ¡ P2 | Optimize drone wheel touch | Better UX | Low |

---

## Recommended Architecture Changes

### 1. Create Visualization Module

Extract all visualization code into a separate module with:
- Cached DOM references
- Single rAF loop (only when playing)
- CSS-driven animations

### 2. Use Web Workers for Non-UI Tasks

Consider moving audio scheduling to a Web Worker to free up the main thread.

### 3. Profile with Chrome DevTools

Run Performance profiler to identify actual bottlenecks:
1. Open DevTools â†’ Performance tab
2. Click Record, play for 10 seconds, stop
3. Look for long tasks in the flame chart

---

## Next Steps

1. [ ] Create GitHub issue with these findings
2. [ ] Implement P0 fixes (DOM caching, draw loop)
3. [ ] Test on target devices (mobile especially)
4. [ ] Profile before/after to measure improvement
